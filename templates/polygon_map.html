<!DOCTYPE html>
<html>
<head>
    <title>Polygon Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <h1>Polygon Map</h1>
    <div id="map"></div>
    <button id="plan-path">Plan Path</button>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map').setView([34.151997, -77.8668216], 18);  // Initialize map with default coordinates and zoom level 18
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 22  // Allow for a higher maximum zoom level
            }).addTo(map);

            var polygon;
            var pathLine;

            fetch('/polygon_data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched polygon data:', data);
                    if (data.length === 0) {
                        console.error('No polygon data found');
                        return;
                    }
                    var polygonCoordinates = data.map(function(coord) {
                        return [coord.lat, coord.lon];
                    });
                    console.log('Polygon coordinates for Leaflet:', polygonCoordinates);
                    if (polygonCoordinates.length > 1) {
                        polygon = L.polygon(polygonCoordinates, {color: 'green'}).addTo(map);
                        map.fitBounds(polygon.getBounds());
                    } else {
                        console.error('Not enough points to form a polygon');
                    }
                })
                .catch((error) => {
                    console.error('Error fetching polygon data:', error);
                });

            document.getElementById('plan-path').addEventListener('click', function() {
                fetch('/plan_path')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched path data:', data);
                        if (pathLine) {
                            map.removeLayer(pathLine);
                        }
                        var pathCoordinates = data.map(function(coord) {
                            return [coord.lat, coord.lon];
                        });
                        console.log('Path coordinates for Leaflet:', pathCoordinates);
                        pathLine = L.polyline(pathCoordinates, {color: 'blue'}).addTo(map);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            });
        });
    </script>
</body>
</html>